<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>設備/耗材借出單</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; }
    .group { margin-bottom: 20px; border: 1px dashed #ccc; padding: 10px; position: relative; }
    .dropdown, .row { position: relative; margin-bottom: 10px; }
    .dropbtn {
      background-color: #3498db; color: white;
      padding: 8px 16px; font-size: 14px;
      border: none; cursor: pointer;
    }
    .dropdown-content {
      display: none; position: absolute;
      background-color: #f9f9f9; min-width: 160px;
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .dropdown-content.show { display: block; }
    .dropdown-content span {
      display: block; padding: 10px;
      cursor: pointer; background: #fff;
      border-bottom: 1px solid #ddd;
    }
    .popup {
      position: absolute; display: none;
      background-color: white; border: 1px solid #ccc;
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      z-index: 9999; min-width: 160px;
    }
    .popup a {
      display: block; padding: 8px 12px;
      color: #333; text-decoration: none;
      cursor: pointer;
    }
    .popup a:hover { background-color: #f1f1f1; }
    .result {
      display: flex; gap: 20px; margin-top: 20px;
      align-items: center; flex-wrap: wrap;
    }
    .level {
      border: 1px solid #d3d3d3;
      background-color: #d3d3d3;
      padding: 8px;
      min-width: 120px;
      font-size: 14px;
    }
    .quantity-wrapper, .borrower-wrapper, .borrow-date-wrapper, .return-date-wrapper {
      display: flex;
      align-items: center;
      font-size: 14px;
    }
    .quantity-wrapper select.quantity-select,
    .borrower-wrapper select.borrower-select {
      font-size: 14px; padding: 4px 6px;
      margin-left: 6px;
      cursor: pointer;
    }
    .borrow-date-wrapper input.borrow-date,
    .return-date-wrapper input.return-date {
      margin-left: 6px;
      padding: 4px 6px;
      font-size: 14px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 2px;
      width: 130px;
    }
    #btnExport, #btnAdd {
      margin-top: 15px; padding: 8px 14px;
      font-size: 14px; cursor: pointer;
      background-color: #2ecc71; color: white;
      border: none; border-radius: 4px;
    }
    #btnAdd { background-color: #f39c12; }
    .btnDelete {
      margin-left: auto;
      background-color: #e74c3c;
      border: none; color: white;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
      flex-shrink: 0;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>

<!-- ✅ 借方 +（靠右）借出人/借出日期/歸還日期：只顯示一次 -->
<div style="margin-bottom: 10px; display:flex; align-items:center; gap:12px; flex-wrap: wrap;">
  <div style="display:flex; align-items:center; gap:8px;">
    借方：
    <input type="text" id="borrowerNameInput" placeholder="請輸入借方名稱" style="padding: 6px; font-size: 14px; width: 200px;" />
  </div>

  <div style="margin-left:auto; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
    <div class="borrower-wrapper">
      借出人:
      <select id="globalBorrower" class="borrower-select">
        <option value="" selected></option>
        <option>Stanley</option>
        <option>Albert</option>
        <option>Tim</option>
      </select>
    </div>

    <div class="borrow-date-wrapper">
      借出日期:
      <input type="text" id="globalBorrowDate" class="borrow-date" placeholder="請選擇日期" />
    </div>

    <div class="return-date-wrapper">
      歸還日期:
      <input type="text" id="globalReturnDate" class="return-date" placeholder="請選擇日期" />
    </div>
  </div>
</div>

<div id="container"></div>
<button id="btnAdd">➕ 新增欄位</button>
<button id="btnExport">匯出 Word</button>
<div id="popup2" class="popup"></div>
<div id="popup3" class="popup"></div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/docx@7.1.1/build/index.min.js"></script>

<script>
  const {
    Document, Packer, Paragraph, TextRun, AlignmentType, TabStopType,
    Header, ImageRun, Table, TableRow, TableCell, WidthType, VerticalAlign, BorderStyle
  } = docx;

  /* 上傳設定（使用你的 Web App exec URL 與 TOKEN） */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbyMcAeH_ws6L5BISgTa-w84NBDKkPOiN-m9bMqKftKl4Hd4PPSQa-eVFSVvXuMKh2kL/exec';
  const TOKEN    = '124616442124';

  /* 將 doc 轉為 base64 上傳到 Apps Script（回傳 JSON，失敗丟出錯誤） */
  async function uploadDocx(doc, fileName) {
    const base64 = await Packer.toBase64String(doc);
    const res = await fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // 避免 CORS 預檢
      body: JSON.stringify({ _token: TOKEN, uploadDocx: { base64, name: fileName } })
    });

    const text = await res.text();
    let json;
    try { json = JSON.parse(text); }
    catch (e) { throw new Error('伺服器回應非 JSON：' + text.slice(0, 200)); }

    if (!json.ok) {
      throw new Error(json.error || `HTTP ${res.status}`);
    }
    return json; // 預期包含 { ok: true, docxId: '...' }
  }

  /* === 選單資料 === */
  const categoryMap = {
    '設備': ['PC','Laptop','monitor','Lan switch box','StepScope','VNA','ECal','LCR meter'],
    '測試探頭': ['PACKETMICRO D-Probe','PACKETMICRO S-Probe','Hand-Probe','FX-C7','SCR10'],
    '測試治具': ['P4M2AE','P6OCP'],
    '接頭': ['2.4(F)-2.92(F)','2.92(F)-mmpx(F)','2.92(F)-2.92(F)','2.92(M)-2.92(F)','0Ω(M)','50Ω(M)'],
    '樣品': ['DL Standard coupon','0.42mm PTFE','De-embeded board','airline'],
    '工具': ['扭力扳手','電動起子','電子放大鏡','腳踏開關','游標卡尺']
  };

  const thirdLevelData = {
    'PC': ['FPE119R','1L55D2G'],
    'Laptop': ['dynabook','LEGION'],
    'monitor': ['BENQ 22.7"','ViewSonic 27"'],
    'Lan switch box': ['D-Link','TP-Link'],
    'StepScope': ['SN003019','SN003020'],
    'PACKETMICRO D-Probe': ['GSSG05-6022','GSSG05-6023','SS05-8814','SS05-8821','SS10-1022','SS10-1077','SS10-A065',
                            'SS05-8332','SS05-8396','SS08-0111','SS08-0112','SS10-0103','SS10-0548'],
    'PACKETMICRO S-Probe': ['GR05-0315','GR05-1044','GR08-0174','GR08-0205','GR10-0091','GR10-0444'],
    'Hand-Probe': ['P1650','AQI-P-SE-25100','AQI-P-DIFF-25100','IPD-100'],
    'P4M2AE': ['P4M2AEB1001'],
    'P6OCP': ['P6OCPB1001','P6OCPL1001'],
    'airline': ['24.8Ω','50.28Ω'],
    '扭力扳手': ['MOUNTZ','PACKETMICRO','Luxshare-ICT'],
  };

  /* === 狀態與基本元素 === */
  let groupIndex = 0;
  const selections = []; // 每個 group: { level1, level2, level3 }
  const container = document.getElementById('container');
  const popup2 = document.getElementById('popup2'); // 第二層彈窗
  const popup3 = document.getElementById('popup3'); // 第三層彈窗
  let activeGroupIdx = null; // 目前開啟選單的 group 索引

  /* === 工具函式 === */
  function closePopups() {
    popup2.style.display = 'none';
    popup3.style.display = 'none';
    popup2.innerHTML = '';
    popup3.innerHTML = '';
    popup2.removeAttribute('data-group');
    popup3.removeAttribute('data-group');
  }

  function closeAllDropdowns() {
    document.querySelectorAll('.dropdown-content').forEach(dd => dd.classList.remove('show'));
    activeGroupIdx = null;
  }

  function positionPopup(el, rect) {
    el.style.top = `${rect.bottom + window.scrollY}px`;
    el.style.left = `${rect.right + 5 + window.scrollX}px`;
  }

  /* === 生成一組欄位（含選單） === */
  function createGroup() {
    const idx = groupIndex++;
    const group = document.createElement('div');
    group.className = 'group';
    group.dataset.idx = idx;
    group.innerHTML = `
      <div class="dropdown">
        <button class="dropbtn">選單</button>
        <div class="dropdown-content">
          ${Object.keys(categoryMap).map(key => `<span data-group="${idx}" data-value="${key}">${key}</span>`).join('')}
        </div>
      </div>
      <div class="result">
        <div class="level">類別: <span class="text1"></span></div>
        <div class="level">項目: <span class="text2"></span></div>
        <div class="level">序號: <span class="text3"></span></div>

        <div class="quantity-wrapper" style="margin-left:20px;">
          數量:
          <select class="quantity-select">
            <option value="" selected></option>
            ${[...Array(8)].map((_, i) => `<option>${i+1}</option>`).join('')}
          </select>
        </div>

        <button class="btnDelete">✖ 刪除欄位</button>
      </div>
    `;
    container.appendChild(group);

    // 開關第一層選單
    const dropbtn = group.querySelector('.dropbtn');
    const dropdownContent = group.querySelector('.dropdown-content');

    dropbtn.addEventListener('click', (e) => {
      e.stopPropagation();
      closePopups();
      if (activeGroupIdx !== idx) {
        closeAllDropdowns();
        activeGroupIdx = idx;
      }
      dropdownContent.classList.toggle('show');
      if (!dropdownContent.classList.contains('show')) activeGroupIdx = null;
    });

    // 第一層 -> 第二層
    group.querySelectorAll('.dropdown-content span').forEach(span => {
      span.addEventListener('click', (e) => {
        e.stopPropagation();
        const level1 = span.dataset.value;
        const gIdx = parseInt(span.dataset.group, 10);
        selections[gIdx] = { level1, level2: null, level3: null };

        group.querySelector('.text1').innerText = level1;
        group.querySelector('.text2').innerText = '';
        group.querySelector('.text3').innerText = '';

        const level2List = categoryMap[level1] || [];
        if (level2List.length === 0) {
          closePopups();
          dropdownContent.classList.remove('show');
          return;
        }

        popup2.innerHTML = level2List.map(item => `<a data-group="${gIdx}" data-value="${item}">${item}</a>`).join('');
        popup2.setAttribute('data-group', gIdx);
        const rect = span.getBoundingClientRect();
        positionPopup(popup2, rect);
        popup2.style.display = 'block';

        popup3.style.display = 'none';
        popup3.innerHTML = '';
        popup3.removeAttribute('data-group');
      });
    });

    // 刪除本組
    group.querySelector('.btnDelete').addEventListener('click', () => {
      if (activeGroupIdx === idx) {
        closeAllDropdowns();
        closePopups();
      }
      container.removeChild(group);
      selections[idx] = null;
    });
  }

  /* ✅ 全域日期只初始化一次 */
  if (typeof flatpickr === 'function') {
    flatpickr(document.getElementById('globalBorrowDate'), { dateFormat: "Y-m-d", locale: "zh" });
    flatpickr(document.getElementById('globalReturnDate'), { dateFormat: "Y-m-d", locale: "zh" });
  }

  /* === 第二層點擊 === */
  popup2.addEventListener('click', (e) => {
    e.stopPropagation();
    if (e.target.tagName !== 'A') return;

    popup3.style.display = 'none';
    popup3.innerHTML = '';
    popup3.removeAttribute('data-group');

    const idx = +e.target.dataset.group;
    const level2 = e.target.dataset.value;
    selections[idx].level2 = level2;

    const group = container.querySelector(`.group[data-idx="${idx}"]`);
    if (group) {
      group.querySelector('.text2').innerText = level2;
      group.querySelector('.text3').innerText = '';
    }

    const third = thirdLevelData[level2] || [];
    if (third.length === 0) {
      popup2.style.display = 'none';
      popup2.innerHTML = '';
      popup2.removeAttribute('data-group');
      const dd = group?.querySelector('.dropdown-content');
      dd && dd.classList.remove('show');
      return;
    }

    popup3.innerHTML = third.map(item => `<a data-group="${idx}" data-value="${item}">${item}</a>`).join('');
    popup3.setAttribute('data-group', idx);
    const rect = e.target.getBoundingClientRect();
    positionPopup(popup3, rect);
    popup3.style.display = 'block';
  });

  /* === 第三層點擊 === */
  popup3.addEventListener('click', (e) => {
    e.stopPropagation();
    if (e.target.tagName !== 'A') return;

    const idx = +e.target.dataset.group;
    const level3 = e.target.dataset.value;
    selections[idx].level3 = level3;

    const group = container.querySelector(`.group[data-idx="${idx}"]`);
    if (group) {
      group.querySelector('.text3').innerText = level3;
      closePopups();
      const dd = group.querySelector('.dropdown-content');
      dd && dd.classList.remove('show');
    }
  });

  /* === 全域關閉邏輯 === */
  document.addEventListener('click', () => {
    closeAllDropdowns();
    closePopups();
  });
  window.addEventListener('scroll', () => closePopups(), { passive: true });
  window.addEventListener('resize', () => closePopups(), { passive: true });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePopups(); });

  /* === 新增欄位按鈕與預設一組 === */
  document.getElementById('btnAdd')?.addEventListener('click', createGroup);
  createGroup();

  /* === 匯出：用 Header 表格 + 白色邊框；標題在正文；先上傳雲端，失敗才下載本機 === */
  document.getElementById('btnExport').addEventListener('click', async () => {
    const btn = document.getElementById('btnExport');
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.textContent = '上傳中...';

    // ✅ 全域借出資訊（只輸出一次）
    const globalBorrower   = document.getElementById('globalBorrower')?.value || '';
    const globalBorrowDate = document.getElementById('globalBorrowDate')?.value || '';
    const globalReturnDate = document.getElementById('globalReturnDate')?.value || '';

    // 讀 LOGO（GitHub raw）
    const logoUrl = 'https://raw.githubusercontent.com/lalu561/Equipment-loan-form/main/Arcanum%20logo.png';
    let logoArrayBuffer = null;
    try {
      const resp = await fetch(logoUrl);
      if (!resp.ok) throw new Error(`Logo 載入失敗：HTTP ${resp.status}`);
      logoArrayBuffer = await resp.arrayBuffer();
    } catch (e) {
      console.warn('Logo 載入失敗', e);
    }

    // ===== Header：左 LOGO、右公司資訊（白色邊框、齊貼頁首下緣） =====
    const whiteBorders = {
      top: { style: BorderStyle.SINGLE, size: 0, color: "FFFFFF" },
      bottom: { style: BorderStyle.SINGLE, size: 0, color: "FFFFFF" },
      left: { style: BorderStyle.SINGLE, size: 0, color: "FFFFFF" },
      right: { style: BorderStyle.SINGLE, size: 0, color: "FFFFFF" },
      insideH: { style: BorderStyle.SINGLE, size: 0, color: "FFFFFF" },
      insideV: { style: BorderStyle.SINGLE, size: 0, color: "FFFFFF" }
    };

    const headerCells = [
      new TableCell({
        children: logoArrayBuffer ? [
          new Paragraph({
            children: [ new ImageRun({ data: logoArrayBuffer, transformation: { width: 150, height: 60 } }) ],
            alignment: AlignmentType.LEFT,
            spacing: { before: 0, after: 0 }
          })
        ] : [],
        verticalAlign: VerticalAlign.BOTTOM,
        borders: whiteBorders,
        width: { size: 50, type: WidthType.PERCENTAGE }
      }),
      new TableCell({
        children: [
          new Paragraph({
            children: [new TextRun({ text: "Arcanum Advanced Inc.", size: 20 })],
            alignment: AlignmentType.RIGHT,
            spacing: { before: 0, after: 0 }
          }),
          new Paragraph({
            children: [new TextRun({ text: "https://www.arcanum-adv.com", size: 20 })],
            alignment: AlignmentType.RIGHT,
            spacing: { before: 0, after: 0 }
          })
        ],
        verticalAlign: VerticalAlign.BOTTOM,
        borders: whiteBorders,
        width: { size: 50, type: WidthType.PERCENTAGE }
      })
    ];

    const headerTable = new Table({
      rows: [ new TableRow({ children: headerCells }) ],
      width: { size: 100, type: WidthType.PERCENTAGE },
      borders: whiteBorders
    });

    // ===== 正文：標題 + 借方 + 清單 =====
    const children = [];

    // 標題在正文（上方空一行）
    children.push(new Paragraph({
      children: [new TextRun({ text: '設備/耗材借出單', bold: true, size: 40 })],
      alignment: AlignmentType.CENTER,
      spacing: { before: 276, after: 300 }
    }));

    const borrowerName = (document.getElementById('borrowerNameInput').value || '').trim() || '______________';
    children.push(new Paragraph({
      children: [new TextRun({ text: `借方：${borrowerName}`, size: 28 })],
      spacing: { after: 200 }
    }));

    let count = 0;
    selections.forEach((sel, idx) => {
      if (!sel) return;
      const group = container.querySelector(`.group[data-idx="${idx}"]`);

      if (!group) return;

      const qty = group.querySelector('.quantity-select')?.value || '';

      count++;

      children.push(new Paragraph({ children: [new TextRun({ text: `第 ${count} 項：`, size: 26 })] }));

      const line1Parts = [];
      if (sel.level1) line1Parts.push(`類別：${sel.level1}`);
      if (sel.level2) line1Parts.push(`項目：${sel.level2}`);
      if (sel.level3) line1Parts.push(`序號：${sel.level3}`);
      if (qty) line1Parts.push(`數量：${qty}`);

      children.push(new Paragraph({
        tabStops: [
          { type: TabStopType.LEFT, position: 0 },     // 類別
          { type: TabStopType.LEFT, position: 2000 },  // 項目
          { type: TabStopType.LEFT, position: 6500 },  // 序號
          { type: TabStopType.LEFT, position: 11500 },  // 數量
        ],
        children: [
          new TextRun({
            text: line1Parts.join('\t'),
            size: 26
          })
        ]
      }));
    });

    if (count === 0) {
      alert('沒有資料');
      btn.disabled = false;
      btn.textContent = originalText;
      return;
    }

    // ✅ 放在所有項目結束後（只顯示一次）
    const footerLineParts = [];
    if (globalBorrower) footerLineParts.push(`借出人：${globalBorrower}`);
    if (globalBorrowDate) footerLineParts.push(`借出日期：${globalBorrowDate}`);
    if (globalReturnDate) footerLineParts.push(`歸還日期：${globalReturnDate}`);

    if (footerLineParts.length) {
      children.push(new Paragraph({
        tabStops: [
          { type: TabStopType.LEFT, position: 0 },
          { type: TabStopType.LEFT, position: 1500 },
          { type: TabStopType.LEFT, position: 4500 },
        ],
        children: [new TextRun({ text: footerLineParts.join('\t'), size: 28 })],
        spacing: { before: 300, after: 300 }
      }));
    }

    children.push(new Paragraph({children:[new TextRun({text: '※於借期間如有損壞以致維修或報廢，借方需依損壞情形原價賠償', size: 22 }), ],
                                 spacing: { before: 400 },
                                }));
    children.push(new Paragraph({children:[new TextRun({text: '※借方簽收借出單，視為同意上述說明', size: 22, }), ],
                                 spacing: { after: 600 },
                                }));

    children.push(new Paragraph({}));
    children.push(new Paragraph({
      tabStops: [
        { type: TabStopType.LEFT, position: 0 },
        { type: TabStopType.RIGHT, position: 9000 },
      ],
      children: [
        new TextRun({ text: `\t借方簽章：______________`, size: 28 }),
      ],
      spacing: { before: 1000 }
    }));

    // ===== 建立文件：中等邊界 + header 高度貼齊 LOGO 下緣 =====
    const doc = new Document({
      creator: "系統",
      title: "設備借出清單",
      description: "借出內容",
      styles: {
        default: {
          document: {
            run: { font: "Microsoft JhengHei", size: 28 },
            paragraph: { spacing: { line: 276 } }
          }
        }
      },
      sections: [{
        properties: {
          page: {
            margin: {
              top: 1440, right: 1440, bottom: 1440, left: 1440,
              header: 850 // 約略對應 LOGO 高度，讓下緣貼齊分隔線
            }
          }
        },
        headers: { default: new Header({ children: [headerTable] }) },
        children
      }]
    });

    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    const rawBorrower = document.getElementById('borrowerNameInput').value || '';
    const safeBorrower = (rawBorrower.trim() || '未填借方').replace(/[\\\/:*?"<>|]/g, '');
    const fileName = `設備^耗材借出單_${safeBorrower}_${formattedDate}.docx`;

    try {
      // 先上傳雲端
      const result = await uploadDocx(doc, fileName);
      alert('已上傳到雲端！檔案ID：' + result.docxId);
    } catch (err) {
      // 上傳失敗才下載本機
      console.error('上傳失敗，改為下載：', err);
      const blob = await Packer.toBlob(doc);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      a.click();
      alert('上傳失敗，已改為下載本機：' + err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  });
</script>
</body>
</html>







